#!/usr/bin/env python3
"""
Browser Extension Penetration Testing â€” Main Orchestrator
Coordinates manifest analysis, auto-exploitation, and report generation.

Usage:
  python3 ext_pentest.py scan /path/to/extension/ [--output report.md]
  python3 ext_pentest.py scan /path/to/extension/ --headers '{"Authorization":"Bearer token"}'
"""

import sys
import json
import argparse
import uuid
from pathlib import Path
from datetime import datetime, timezone

# Local modules
sys.path.insert(0, str(Path(__file__).parent))
import manifest_analyzer
import exploit_runner
import report_generator


def find_manifest(ext_dir: str) -> str | None:
    for candidate in ["manifest.json", "manifest.webmanifest"]:
        p = Path(ext_dir) / candidate
        if p.exists():
            return str(p)
    return None


def do_scan(ext_dir: str, output: str, headers_json: str):
    ext_path = Path(ext_dir).resolve()
    if not ext_path.exists():
        print(json.dumps({"error": f"Extension path not found: {ext_dir}"}))
        sys.exit(1)

    out_dir = Path(output).parent / "ext_pentest_artifacts"
    scan_id = uuid.uuid4().hex[:8]
    print(json.dumps({"scan_id": scan_id, "target": str(ext_path), "status": "started"}))

    all_findings = []

    # â”€â”€ Phase 1: Manifest Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n[Phase 1/3] ğŸ” Analyzing extension manifest...")
    manifest_path = find_manifest(ext_dir)
    ext_name = "Unknown Extension"
    ext_version = "?"

    if manifest_path:
        manifest_findings, manifest = manifest_analyzer.analyze(manifest_path)
        ext_name = manifest.get("name", "Unknown Extension")
        ext_version = manifest.get("version", "?")
        print(f"  âœ“ Extension: {ext_name} v{ext_version}")
        print(f"  âœ“ Manifest findings: {len(manifest_findings)}")
        all_findings.extend(manifest_findings)
    else:
        print("  âš  No manifest.json found â€” skipping manifest analysis")

    # â”€â”€ Phase 2: Dynamic Exploit + Screenshot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print("\n[Phase 2/3] ğŸ’¥ Running auto-exploit engine with Playwright...")
    extra_headers = {}
    if headers_json and headers_json != "{}":
        try:
            extra_headers = json.loads(headers_json)
        except Exception:
            pass

    try:
        dynamic_findings = exploit_runner.run(ext_dir, str(out_dir))
        print(f"  âœ“ Dynamic exploit findings: {len(dynamic_findings)}")
        all_findings.extend(dynamic_findings)
    except Exception as e:
        print(f"  âš  Dynamic exploit engine error: {e}")
        print("  â†’ Tip: Run `python3 -m playwright install chromium` to enable browser exploitation")

    # â”€â”€ Phase 3: Report Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    print(f"\n[Phase 3/3] ğŸ“ Generating detailed report â†’ {output}")
    report_path = report_generator.generate(
        findings=all_findings,
        ext_name=ext_name,
        ext_version=ext_version,
        target_path=str(ext_path),
        output_file=output
    )

    confirmed = [f for f in all_findings if f.get("confirmed", False)]
    by_sev = {}
    for f in all_findings:
        s = f.get("severity", "INFO")
        by_sev[s] = by_sev.get(s, 0) + 1

    print(json.dumps({
        "scan_id": scan_id,
        "status": "completed",
        "extension": f"{ext_name} v{ext_version}",
        "total_findings": len(all_findings),
        "confirmed_exploitable": len(confirmed),
        "by_severity": by_sev,
        "report": report_path,
        "artifacts_dir": str(out_dir),
    }, indent=2))


if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="ğŸ§© Browser Extension Penetration Testing â€” Automated Exploit + Report"
    )
    subparsers = parser.add_subparsers(dest="action", required=True)

    p_scan = subparsers.add_parser("scan", help="Full pentest of an unpacked extension directory")
    p_scan.add_argument("ext_dir", help="Path to unpacked extension directory")
    p_scan.add_argument("--output", default="ext_pentest_report.md", help="Report output path")
    p_scan.add_argument("--headers", default="{}", help='JSON auth headers e.g. \'{"Authorization":"Bearer token"}\'')

    args = parser.parse_args()
    if args.action == "scan":
        do_scan(args.ext_dir, args.output, args.headers)
