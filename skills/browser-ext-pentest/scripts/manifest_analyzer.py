#!/usr/bin/env python3
"""
Browser Extension Manifest Analyzer
Audits manifest.json for dangerous permissions, missing CSP, and security misconfigurations.
"""

import json
import sys
import os
from pathlib import Path

DANGEROUS_PERMISSIONS = {
    "<all_urls>":       ("CRITICAL", "9.1", "CWE-250", "A01:2021", "Extension can read/modify ALL websites. Massive attack surface."),
    "http://*/*":       ("HIGH",     "8.1", "CWE-250", "A01:2021", "Can access all HTTP sites — including sensitive pages."),
    "https://*/*":      ("HIGH",     "8.1", "CWE-250", "A01:2021", "Can access all HTTPS sites."),
    "webRequest":       ("HIGH",     "7.5", "CWE-200", "A02:2021", "Can intercept and read all network requests including credentials."),
    "webRequestBlocking":("CRITICAL","9.0", "CWE-200", "A02:2021", "Can block and modify network requests — MITM capability."),
    "nativeMessaging":  ("HIGH",     "8.5", "CWE-78",  "A03:2021", "Can communicate with native host applications — RCE risk."),
    "debugger":         ("CRITICAL", "9.8", "CWE-264", "A01:2021", "Full browser debugger API — can read all tabs, modify JS execution."),
    "cookies":          ("HIGH",     "7.5", "CWE-315", "A02:2021", "Read/write all cookies for any domain."),
    "tabs":             ("MEDIUM",   "5.3", "CWE-200", "A01:2021", "Read all tab URLs, titles, and favicons."),
    "history":          ("MEDIUM",   "5.3", "CWE-200", "A02:2021", "Access full browser history."),
    "topSites":         ("LOW",      "3.1", "CWE-200", "A02:2021", "Read most visited sites."),
    "identity":         ("MEDIUM",   "6.5", "CWE-287", "A07:2021", "Access OAuth tokens for signed-in Google account."),
    "management":       ("HIGH",     "7.8", "CWE-264", "A01:2021", "Can install, uninstall, or disable other extensions."),
    "proxy":            ("HIGH",     "7.5", "CWE-441", "A01:2021", "Can redirect all browser traffic through attacker-controlled proxy."),
    "clipboardRead":    ("MEDIUM",   "5.3", "CWE-200", "A02:2021", "Can read clipboard — may capture passwords/sensitive data."),
    "clipboardWrite":   ("MEDIUM",   "4.3", "CWE-79",  "A03:2021", "Can inject clipboard content — phishing risk."),
    "bookmarks":        ("LOW",      "3.1", "CWE-200", "A02:2021", "Read all bookmarks."),
    "downloads":        ("MEDIUM",   "5.5", "CWE-494", "A08:2021", "Can trigger file downloads without user interaction."),
}

WEAK_CSP_INDICATORS = [
    ("unsafe-inline", "HIGH",   "Allows inline scripts — XSS exploitation enabled."),
    ("unsafe-eval",   "HIGH",   "Allows eval() — arbitrary code execution risk."),
    ("*",             "MEDIUM", "Wildcard source in CSP — bypasses content origin restrictions."),
    ("http:",         "MEDIUM", "HTTP sources allowed in CSP — enables MitM script injection."),
    ("data:",         "MEDIUM", "data: URI sources allowed — XSS vector."),
]

def analyze(manifest_path: str) -> list[dict]:
    p = Path(manifest_path)
    if not p.exists():
        print(f"[ERROR] {manifest_path} not found")
        sys.exit(1)

    with open(p) as f:
        manifest = json.load(f)

    findings = []

    # Permission audit
    all_perms = manifest.get("permissions", []) + manifest.get("optional_permissions", [])
    host_perms = manifest.get("host_permissions", [])  # MV3
    all_perms += host_perms

    for perm in all_perms:
        if perm in DANGEROUS_PERMISSIONS:
            sev, cvss, cwe, owasp, desc = DANGEROUS_PERMISSIONS[perm]
            findings.append({
                "category": "Manifest — Dangerous Permission",
                "title": f"Dangerous Permission: `{perm}`",
                "severity": sev,
                "cvss": cvss,
                "cwe": cwe,
                "owasp": owasp,
                "description": desc,
                "poc": f"Permission `{perm}` declared in manifest.json",
                "exploit_steps": [
                    f"1. Locate `{perm}` in manifest.json permissions array",
                    f"2. Trigger the corresponding chrome API from background/content script",
                    f"3. Observe unrestricted access granted by the browser",
                ],
                "remediation": f"Remove `{perm}` if not essential. Use least-privilege alternatives.",
                "evidence_file": None,
            })

    # CSP audit
    csp = manifest.get("content_security_policy", "")
    if not csp:
        findings.append({
            "category": "Manifest — Missing CSP",
            "title": "No Content Security Policy Defined",
            "severity": "HIGH",
            "cvss": "7.4",
            "cwe": "CWE-1021",
            "owasp": "A05:2021 - Security Misconfiguration",
            "description": "No CSP defined. Extension is vulnerable to XSS via injected scripts.",
            "poc": "Inject <script>alert(document.cookie)</script> via DOM sink in content script",
            "exploit_steps": [
                "1. Identify DOM sinks in content scripts (innerHTML, document.write)",
                "2. Inject payload via URL parameter or message",
                "3. XSS executes in extension context with extension privileges",
            ],
            "remediation": "Add `content_security_policy` to manifest: `script-src 'self'; object-src 'none'`",
            "evidence_file": None,
        })
    else:
        for indicator, sev, desc in WEAK_CSP_INDICATORS:
            if indicator in csp:
                findings.append({
                    "category": "Manifest — Weak CSP",
                    "title": f"Weak CSP Directive: `{indicator}`",
                    "severity": sev,
                    "cvss": "6.1",
                    "cwe": "CWE-1021",
                    "owasp": "A05:2021 - Security Misconfiguration",
                    "description": desc,
                    "poc": f"CSP value: `{csp}`\nIndicator `{indicator}` weakens protection.",
                    "exploit_steps": [
                        f"1. Observe CSP: `{csp}`",
                        f"2. Craft payload exploiting `{indicator}` bypass",
                        "3. Inject via content script DOM sink or message handler",
                    ],
                    "remediation": f"Remove `{indicator}` from CSP. Enforce `script-src 'self'`.",
                    "evidence_file": None,
                })

    # Background scripts
    bg = manifest.get("background", {})
    if bg.get("scripts") or bg.get("service_worker"):
        findings.append({
            "category": "Manifest — Background Context",
            "title": "Background Script / Service Worker Detected",
            "severity": "INFO",
            "cvss": "0.0",
            "cwe": "CWE-200",
            "owasp": "A05:2021 - Security Misconfiguration",
            "description": "Extension runs persistent background context. Review for message handler injection and secret storage.",
            "poc": "Inspect background.js for chrome.runtime.onMessage handlers with no origin validation",
            "exploit_steps": [
                "1. Open chrome://extensions → click 'Inspect views: background page'",
                "2. In DevTools console: chrome.runtime.sendMessage({action:'...'}, cb)",
                "3. Observe unvalidated message handlers executing privileged operations",
            ],
            "remediation": "Validate message sender origin in onMessage handlers. Never trust message content blindly.",
            "evidence_file": None,
        })

    # MV2 vs MV3
    mv = manifest.get("manifest_version", 2)
    if mv == 2:
        findings.append({
            "category": "Manifest — Outdated Manifest Version",
            "title": "Manifest V2 (Deprecated — Wider Attack Surface)",
            "severity": "MEDIUM",
            "cvss": "5.3",
            "cwe": "CWE-1096",
            "owasp": "A06:2021 - Vulnerable and Outdated Components",
            "description": "MV2 allows background pages with persistent DOM, broader webRequest blocking, and eval(). More dangerous than MV3.",
            "poc": "Check manifest_version field: currently " + str(mv),
            "exploit_steps": [
                "1. Open DevTools on background page",
                "2. Eval arbitrary JS: eval('chrome.tabs.query({}, t => console.log(t))')",
                "3. Persistent background page maintains state across sessions",
            ],
            "remediation": "Migrate to Manifest V3. Chrome is deprecating MV2 in 2025.",
            "evidence_file": None,
        })

    return findings, manifest


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: manifest_analyzer.py <path/to/manifest.json>")
        sys.exit(1)

    findings, manifest = analyze(sys.argv[1])
    print(json.dumps({
        "extension_name": manifest.get("name", "Unknown"),
        "version": manifest.get("version", "?"),
        "manifest_version": manifest.get("manifest_version", 2),
        "findings_count": len(findings),
        "findings": findings
    }, indent=2))
